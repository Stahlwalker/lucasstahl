name: Check Links

# Runs every Monday at 9 AM UTC (4 AM EST / 1 AM PST)
on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allows manual triggering

jobs:
  link-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check links with Lychee
        uses: lycheeverse/lychee-action@v2.0.2
        with:
          # Crawl the entire site starting from homepage
          args: |
            --verbose
            --no-progress
            --accept 200,201,202,203,204,206,301,302,303,304,307,308,429
            --exclude-all-private
            --exclude '^mailto:'
            --exclude 'linkedin.com/in'
            --exclude 'twitter.com'
            --exclude 'facebook.com'
            --exclude 'instagram.com'
            --exclude 'fonts.googleapis.com/$'
            --exclude 'fonts.gstatic.com/$'
            --exclude 'us-i.posthog.com/$'
            --exclude 'cdnjs.cloudflare.com/$'
            --exclude 'maxcdn.bootstrapcdn.com/$'
            --max-retries 3
            --retry-wait-time 5
            --timeout 30
            https://lukestahl.io/
          # Fail only if there are broken links (not warnings)
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Issue if links are broken
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });

            // If there's already an open issue, add a comment instead
            if (issues.data.length > 0) {
              const existingIssue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ðŸ”— **Broken links still detected on ${new Date().toLocaleDateString()}**\n\n` +
                      `The link checker found broken links again.\n\n` +
                      `[View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            } else {
              // Create a new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”— Broken Links Detected',
                body: `## Broken Links Found\n\n` +
                      `The automated link checker found broken links on your site.\n\n` +
                      `### Details\n` +
                      `- **Date**: ${new Date().toLocaleDateString()}\n` +
                      `- **Pages Checked**: All pages on lukestahl.io\n\n` +
                      `### Action Required\n` +
                      `1. Review the [workflow run logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details\n` +
                      `2. Fix or remove broken links\n` +
                      `3. Close this issue once fixed\n\n` +
                      `---\n` +
                      `*This issue was automatically created by the link checker workflow.*`,
                labels: ['broken-links', 'maintenance']
              });
            }

      - name: Send Email Notification
        if: always()
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          TO_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            SUBJECT="âœ… Link Check Passed - lukestahl.io"
            BODY="<h2>âœ… All Links Working</h2><p>The automated link checker ran successfully on <strong>$(date '+%B %d, %Y')</strong>.</p><p><strong>Result:</strong> No broken links found! All links across your site are working properly.</p><hr><p><strong>Pages Checked:</strong> All pages on lukestahl.io</p><p><a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Workflow Run</a></p>"
          else
            SUBJECT="ðŸ”— Broken Links Detected on lukestahl.io"
            BODY="<h2>ðŸ”— Broken Links Detected</h2><p>The automated link checker found broken links on your site on <strong>$(date '+%B %d, %Y')</strong>.</p><h3>Action Required</h3><ol><li>Review the <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">workflow run logs</a> for details</li><li>Fix or remove broken links</li><li>Close the GitHub issue once fixed</li></ol><hr><p><strong>Pages Checked:</strong> All pages on lukestahl.io</p><p><a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Workflow Run</a></p>"
          fi

          # Use jq to properly escape the JSON
          PAYLOAD=$(jq -n \
            --arg from "$FROM_EMAIL" \
            --arg to "$TO_EMAIL" \
            --arg subject "$SUBJECT" \
            --arg html "$BODY" \
            '{from: $from, to: [$to], subject: $subject, html: $html}')

          echo "Sending email from: $FROM_EMAIL to: $TO_EMAIL"
          RESPONSE=$(curl -w "\nHTTP_STATUS:%{http_code}" -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer $RESEND_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Resend API Response: $RESPONSE"

          HTTP_STATUS=$(echo "$RESPONSE" | grep HTTP_STATUS | cut -d':' -f2)
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: Email sending failed with status $HTTP_STATUS"
          else
            echo "Email sent successfully!"
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ”— Link Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **All links are working!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No broken links were found across your entire site." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Broken links detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details on which links are broken." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Checked: https://lukestahl.io/ (all pages)" >> $GITHUB_STEP_SUMMARY
