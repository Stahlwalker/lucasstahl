name: Weekly Cross-Browser Health Checks

# Runs every Monday at 6 AM UTC (2 AM EST / 11 PM PST Sunday)
# Runs simple health checks across Chromium, Firefox, and WebKit
# Verifies pages load successfully without checking specific features
on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:  # Allows manual triggering

jobs:
  playwright-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'astro-site/package-lock.json'

      - name: Install dependencies
        run: cd astro-site && npm ci

      - name: Install Playwright Browsers
        run: cd astro-site && npx playwright install --with-deps chromium firefox webkit

      - name: Run Playwright tests against production
        run: cd astro-site && npx playwright test
        continue-on-error: true
        id: playwright
        env:
          CI: true

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: astro-site/playwright-report/
          retention-days: 30

      - name: Create Issue if tests fail
        if: steps.playwright.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'playwright-tests'
            });

            // If there's already an open issue, add a comment instead
            if (issues.data.length > 0) {
              const existingIssue = issues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `ðŸš¨ **Health checks failed again on ${new Date().toLocaleDateString()}**\n\n` +
                      `Cross-browser health checks detected issues.\n\n` +
                      `[View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})\n` +
                      `[Download test report](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)`
              });
            } else {
              // Create a new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Cross-Browser Health Checks Failed',
                body: `## Health Check Failures\n\n` +
                      `The automated cross-browser health checks found issues on your production site.\n\n` +
                      `### Details\n` +
                      `- **Date**: ${new Date().toLocaleDateString()}\n` +
                      `- **Site Tested**: https://lukestahl.io\n` +
                      `- **Browsers Tested**: Chromium, Firefox, WebKit (Safari)\n` +
                      `- **Tests**: HTTP status checks, page load verification, JavaScript error detection\n\n` +
                      `### Action Required\n` +
                      `1. Review the [workflow run logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details\n` +
                      `2. Download the [Playwright HTML report](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts) for detailed results\n` +
                      `3. Check if pages are loading correctly in each browser\n` +
                      `4. Close this issue once fixed\n\n` +
                      `---\n` +
                      `*This issue was automatically created by the health check workflow.*`,
                labels: ['playwright-tests', 'monitoring']
              });
            }

      - name: Send Email Notification
        if: always()
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          TO_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        run: |
          if [ "${{ steps.playwright.outcome }}" == "success" ]; then
            SUBJECT="âœ… Cross-Browser Health Checks Passed - lukestahl.io"
            BODY="<h2>âœ… All Health Checks Passing</h2><p>The automated cross-browser health checks ran successfully on <strong>$(date '+%B %d, %Y')</strong> against your production site.</p><p><strong>Result:</strong> All pages load successfully across Chromium, Firefox, and WebKit!</p><hr><h3>Pages Checked:</h3><ul><li>Homepage (200 OK)</li><li>Blog page (200 OK)</li><li>About page (200 OK)</li><li>Builds page (200 OK)</li><li>Gems page (200 OK)</li><li>404 handling (works correctly)</li><li>JavaScript errors (none detected)</li></ul><p><strong>Site Tested:</strong> https://lukestahl.io</p><p><a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Workflow Run</a></p>"
          else
            SUBJECT="ðŸš¨ Cross-Browser Health Checks Failed on lukestahl.io"
            BODY="<h2>ðŸš¨ Health Check Failures Detected</h2><p>The automated health checks found issues on your production site on <strong>$(date '+%B %d, %Y')</strong>.</p><p>This could indicate pages are returning errors, not loading, or experiencing browser-specific issues.</p><h3>Action Required</h3><ol><li>Review the <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">workflow run logs</a> for details</li><li>Download the <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts\">Playwright HTML report</a> for detailed results</li><li>Check if pages are loading correctly in each browser</li><li>Close the GitHub issue once fixed</li></ol><hr><p><strong>Site Tested:</strong> https://lukestahl.io</p><p><strong>Browsers Tested:</strong> Chromium, Firefox, WebKit (Safari)</p><p><a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Full Workflow Run</a></p>"
          fi

          # Use jq to properly escape the JSON
          PAYLOAD=$(jq -n \
            --arg from "$FROM_EMAIL" \
            --arg to "$TO_EMAIL" \
            --arg subject "$SUBJECT" \
            --arg html "$BODY" \
            '{from: $from, to: [$to], subject: $subject, html: $html}')

          echo "Sending email from: $FROM_EMAIL to: $TO_EMAIL"
          RESPONSE=$(curl -w "\nHTTP_STATUS:%{http_code}" -X POST "https://api.resend.com/emails" \
            -H "Authorization: Bearer $RESEND_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          echo "Resend API Response: $RESPONSE"

          HTTP_STATUS=$(echo "$RESPONSE" | grep HTTP_STATUS | cut -d':' -f2)
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: Email sending failed with status $HTTP_STATUS"
          else
            echo "Email sent successfully!"
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "# ðŸ¥ Cross-Browser Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.playwright.outcome }}" == "success" ]; then
            echo "âœ… **All health checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All pages loaded successfully across:" >> $GITHUB_STEP_SUMMARY
            echo "- Chromium âœ“" >> $GITHUB_STEP_SUMMARY
            echo "- Firefox âœ“" >> $GITHUB_STEP_SUMMARY
            echo "- WebKit (Safari) âœ“" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Pages Verified:** Homepage, Blog, About, Builds, Gems, 404 handling" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Health checks failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some pages are not loading correctly. Please review the logs for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š [Download Playwright HTML Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Site Tested:** https://lukestahl.io" >> $GITHUB_STEP_SUMMARY
          echo "**Test Date:** $(date '+%B %d, %Y at %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Next scheduled run:** Next Monday at 6:00 AM UTC" >> $GITHUB_STEP_SUMMARY
