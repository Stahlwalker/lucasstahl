name: Weekly Performance Check

# Runs every Sunday at 9 AM UTC (4 AM EST / 1 AM PST)
on:
  schedule:
    - cron: '0 9 * * 0'
  workflow_dispatch:  # Allows manual triggering from Actions tab

jobs:
  performance-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Check Performance - Home
        id: home
        run: |
          echo "Testing homepage..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          # Check if API returned an error
          ERROR=$(echo $RESULT | jq -r '.error.message // empty')
          if [ ! -z "$ERROR" ]; then
            echo "API Error: $ERROR"
            echo "performance=0" >> $GITHUB_OUTPUT
            echo "accessibility=0" >> $GITHUB_OUTPUT
            echo "best_practices=0" >> $GITHUB_OUTPUT
            echo "seo=0" >> $GITHUB_OUTPUT
            echo "lcp=0" >> $GITHUB_OUTPUT
            echo "cls=0" >> $GITHUB_OUTPUT
            echo "tbt=0" >> $GITHUB_OUTPUT
            exit 1
          fi

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          LCP=$(echo $RESULT | jq -r '.lighthouseResult.audits["largest-contentful-paint"].numericValue // 0')
          CLS=$(echo $RESULT | jq -r '.lighthouseResult.audits["cumulative-layout-shift"].numericValue // 0')
          TBT=$(echo $RESULT | jq -r '.lighthouseResult.audits["total-blocking-time"].numericValue // 0')

          echo "Performance: $PERF"
          echo "Accessibility: $A11Y"
          echo "Best Practices: $BP"
          echo "SEO: $SEO"

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT
          echo "lcp=$LCP" >> $GITHUB_OUTPUT
          echo "cls=$CLS" >> $GITHUB_OUTPUT
          echo "tbt=$TBT" >> $GITHUB_OUTPUT

      - name: Check Performance - About
        id: about
        continue-on-error: true
        run: |
          echo "Testing about page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/about&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Blog
        id: blog
        continue-on-error: true
        run: |
          echo "Testing blog page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/blog&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Builds
        id: builds
        continue-on-error: true
        run: |
          echo "Testing builds page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/builds&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Gems
        id: gems
        continue-on-error: true
        run: |
          echo "Testing gems page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/gems&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Home Desktop
        id: home-desktop
        continue-on-error: true
        run: |
          echo "Testing homepage (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          LCP=$(echo $RESULT | jq -r '.lighthouseResult.audits["largest-contentful-paint"].numericValue // 0')
          CLS=$(echo $RESULT | jq -r '.lighthouseResult.audits["cumulative-layout-shift"].numericValue // 0')
          TBT=$(echo $RESULT | jq -r '.lighthouseResult.audits["total-blocking-time"].numericValue // 0')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT
          echo "lcp=$LCP" >> $GITHUB_OUTPUT
          echo "cls=$CLS" >> $GITHUB_OUTPUT
          echo "tbt=$TBT" >> $GITHUB_OUTPUT

      - name: Check Performance - About Desktop
        id: about-desktop
        continue-on-error: true
        run: |
          echo "Testing about page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/about&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Blog Desktop
        id: blog-desktop
        continue-on-error: true
        run: |
          echo "Testing blog page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/blog&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Builds Desktop
        id: builds-desktop
        continue-on-error: true
        run: |
          echo "Testing builds page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/builds&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Gems Desktop
        id: gems-desktop
        continue-on-error: true
        run: |
          echo "Testing gems page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/gems&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo&key=${{ secrets.PAGESPEED_API_KEY }}")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Generate Summary
        run: |
          echo "# üìä Weekly Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Core Web Vitals" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Mobile (Homepage)" >> $GITHUB_STEP_SUMMARY
          echo "- **LCP**: ${{ steps.home.outputs.lcp }}ms (threshold: <8000ms)" >> $GITHUB_STEP_SUMMARY
          echo "- **CLS**: ${{ steps.home.outputs.cls }} (threshold: <0.1)" >> $GITHUB_STEP_SUMMARY
          echo "- **TBT**: ${{ steps.home.outputs.tbt }}ms (target: <300ms)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üñ•Ô∏è Desktop (Homepage)" >> $GITHUB_STEP_SUMMARY
          echo "- **LCP**: ${{ steps.home-desktop.outputs.lcp }}ms (threshold: <2500ms)" >> $GITHUB_STEP_SUMMARY
          echo "- **CLS**: ${{ steps.home-desktop.outputs.cls }} (threshold: <0.1)" >> $GITHUB_STEP_SUMMARY
          echo "- **TBT**: ${{ steps.home-desktop.outputs.tbt }}ms (target: <300ms)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì± Mobile Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Page | Performance | Accessibility | Best Practices | SEO |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|---------------|----------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Home | ${{ steps.home.outputs.performance }} | ${{ steps.home.outputs.accessibility }} | ${{ steps.home.outputs.best_practices }} | ${{ steps.home.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| About | ${{ steps.about.outputs.performance }} | ${{ steps.about.outputs.accessibility }} | ${{ steps.about.outputs.best_practices }} | ${{ steps.about.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog | ${{ steps.blog.outputs.performance }} | ${{ steps.blog.outputs.accessibility }} | ${{ steps.blog.outputs.best_practices }} | ${{ steps.blog.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Builds | ${{ steps.builds.outputs.performance }} | ${{ steps.builds.outputs.accessibility }} | ${{ steps.builds.outputs.best_practices }} | ${{ steps.builds.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gems | ${{ steps.gems.outputs.performance }} | ${{ steps.gems.outputs.accessibility }} | ${{ steps.gems.outputs.best_practices }} | ${{ steps.gems.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üñ•Ô∏è Desktop Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Page | Performance | Accessibility | Best Practices | SEO |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|---------------|----------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Home | ${{ steps.home-desktop.outputs.performance }} | ${{ steps.home-desktop.outputs.accessibility }} | ${{ steps.home-desktop.outputs.best_practices }} | ${{ steps.home-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| About | ${{ steps.about-desktop.outputs.performance }} | ${{ steps.about-desktop.outputs.accessibility }} | ${{ steps.about-desktop.outputs.best_practices }} | ${{ steps.about-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog | ${{ steps.blog-desktop.outputs.performance }} | ${{ steps.blog-desktop.outputs.accessibility }} | ${{ steps.blog-desktop.outputs.best_practices }} | ${{ steps.blog-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Builds | ${{ steps.builds-desktop.outputs.performance }} | ${{ steps.builds-desktop.outputs.accessibility }} | ${{ steps.builds-desktop.outputs.best_practices }} | ${{ steps.builds-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gems | ${{ steps.gems-desktop.outputs.performance }} | ${{ steps.gems-desktop.outputs.accessibility }} | ${{ steps.gems-desktop.outputs.best_practices }} | ${{ steps.gems-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View detailed reports on PageSpeed Insights](https://pagespeed.web.dev/?url=https://lucasstahl.com/)" >> $GITHUB_STEP_SUMMARY

      - name: Performance Summary
        run: |
          echo "## üìä Performance Summary"
          echo ""
          echo "### üì± Mobile Scores"
          echo "- Home: ${{ steps.home.outputs.performance }}"
          echo "- About: ${{ steps.about.outputs.performance }}"
          echo "- Blog: ${{ steps.blog.outputs.performance }}"
          echo "- Builds: ${{ steps.builds.outputs.performance }}"
          echo "- Gems: ${{ steps.gems.outputs.performance }}"
          echo ""
          echo "### üñ•Ô∏è Desktop Scores"
          echo "- Home: ${{ steps.home-desktop.outputs.performance }}"
          echo "- About: ${{ steps.about-desktop.outputs.performance }}"
          echo "- Blog: ${{ steps.blog-desktop.outputs.performance }}"
          echo "- Builds: ${{ steps.builds-desktop.outputs.performance }}"
          echo "- Gems: ${{ steps.gems-desktop.outputs.performance }}"
          echo ""
          echo "### üéØ Core Web Vitals (Mobile)"
          echo "- LCP: ${{ steps.home.outputs.lcp }}ms"
          echo "- CLS: ${{ steps.home.outputs.cls }}"
          echo "- TBT: ${{ steps.home.outputs.tbt }}ms"
          echo ""
          echo "### üéØ Core Web Vitals (Desktop)"
          echo "- LCP: ${{ steps.home-desktop.outputs.lcp }}ms"
          echo "- CLS: ${{ steps.home-desktop.outputs.cls }}"
          echo "- TBT: ${{ steps.home-desktop.outputs.tbt }}ms"
          echo ""
          echo "‚úÖ Weekly performance check complete!"

      - name: Create Performance Report Issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPORT=$(cat <<'EOF'
          ## üìä Weekly Performance Report - $(date '+%B %d, %Y')

          ### üì± Mobile Performance Scores
          | Page | Score |
          |------|-------|
          | Home | ${{ steps.home.outputs.performance }} |
          | About | ${{ steps.about.outputs.performance }} |
          | Blog | ${{ steps.blog.outputs.performance }} |
          | Builds | ${{ steps.builds.outputs.performance }} |
          | Gems | ${{ steps.gems.outputs.performance }} |

          ### üñ•Ô∏è Desktop Performance Scores
          | Page | Score |
          |------|-------|
          | Home | ${{ steps.home-desktop.outputs.performance }} |
          | About | ${{ steps.about-desktop.outputs.performance }} |
          | Blog | ${{ steps.blog-desktop.outputs.performance }} |
          | Builds | ${{ steps.builds-desktop.outputs.performance }} |
          | Gems | ${{ steps.gems-desktop.outputs.performance }} |

          ### üéØ Core Web Vitals

          **üì± Mobile (Homepage)**
          - **LCP**: ${{ steps.home.outputs.lcp }}ms (target: <2500ms)
          - **CLS**: ${{ steps.home.outputs.cls }} (target: <0.1)
          - **TBT**: ${{ steps.home.outputs.tbt }}ms (target: <300ms)

          **üñ•Ô∏è Desktop (Homepage)**
          - **LCP**: ${{ steps.home-desktop.outputs.lcp }}ms (target: <2500ms)
          - **CLS**: ${{ steps.home-desktop.outputs.cls }} (target: <0.1)
          - **TBT**: ${{ steps.home-desktop.outputs.tbt }}ms (target: <300ms)

          ---

          üîó [View Full Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          üîó [Test on PageSpeed Insights](https://pagespeed.web.dev/?url=https://lucasstahl.com/)
          EOF
          )

          gh issue create \
            --title "üìä Weekly Performance Report - $(date '+%B %d, %Y')" \
            --body "$REPORT" \
            --label "performance" \
            --repo ${{ github.repository }}
