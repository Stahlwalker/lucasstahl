name: Weekly Performance Check

# Runs every Sunday at 9 AM UTC (4 AM EST / 1 AM PST)
on:
  schedule:
    - cron: '0 9 * * 0'
  workflow_dispatch:  # Allows manual triggering from Actions tab

jobs:
  performance-check:
    runs-on: ubuntu-latest

    steps:
      - name: Check Performance - Home
        id: home
        run: |
          echo "Testing homepage..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo")

          # Check if API returned an error
          ERROR=$(echo $RESULT | jq -r '.error.message // empty')
          if [ ! -z "$ERROR" ]; then
            echo "API Error: $ERROR"
            echo "performance=0" >> $GITHUB_OUTPUT
            echo "accessibility=0" >> $GITHUB_OUTPUT
            echo "best_practices=0" >> $GITHUB_OUTPUT
            echo "seo=0" >> $GITHUB_OUTPUT
            echo "lcp=0" >> $GITHUB_OUTPUT
            echo "cls=0" >> $GITHUB_OUTPUT
            echo "tbt=0" >> $GITHUB_OUTPUT
            exit 1
          fi

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          LCP=$(echo $RESULT | jq -r '.lighthouseResult.audits["largest-contentful-paint"].numericValue // 0')
          CLS=$(echo $RESULT | jq -r '.lighthouseResult.audits["cumulative-layout-shift"].numericValue // 0')
          TBT=$(echo $RESULT | jq -r '.lighthouseResult.audits["total-blocking-time"].numericValue // 0')

          echo "Performance: $PERF"
          echo "Accessibility: $A11Y"
          echo "Best Practices: $BP"
          echo "SEO: $SEO"

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT
          echo "lcp=$LCP" >> $GITHUB_OUTPUT
          echo "cls=$CLS" >> $GITHUB_OUTPUT
          echo "tbt=$TBT" >> $GITHUB_OUTPUT

      - name: Check Performance - About
        id: about
        continue-on-error: true
        run: |
          echo "Testing about page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/about&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Blog
        id: blog
        continue-on-error: true
        run: |
          echo "Testing blog page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/blog&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Builds
        id: builds
        continue-on-error: true
        run: |
          echo "Testing builds page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/builds&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Gems
        id: gems
        continue-on-error: true
        run: |
          echo "Testing gems page..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/gems&strategy=mobile&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Home Desktop
        id: home-desktop
        continue-on-error: true
        run: |
          echo "Testing homepage (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          LCP=$(echo $RESULT | jq -r '.lighthouseResult.audits["largest-contentful-paint"].numericValue // 0')
          CLS=$(echo $RESULT | jq -r '.lighthouseResult.audits["cumulative-layout-shift"].numericValue // 0')
          TBT=$(echo $RESULT | jq -r '.lighthouseResult.audits["total-blocking-time"].numericValue // 0')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT
          echo "lcp=$LCP" >> $GITHUB_OUTPUT
          echo "cls=$CLS" >> $GITHUB_OUTPUT
          echo "tbt=$TBT" >> $GITHUB_OUTPUT

      - name: Check Performance - About Desktop
        id: about-desktop
        continue-on-error: true
        run: |
          echo "Testing about page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/about&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Blog Desktop
        id: blog-desktop
        continue-on-error: true
        run: |
          echo "Testing blog page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/blog&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Builds Desktop
        id: builds-desktop
        continue-on-error: true
        run: |
          echo "Testing builds page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/builds&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Check Performance - Gems Desktop
        id: gems-desktop
        continue-on-error: true
        run: |
          echo "Testing gems page (desktop)..."
          RESULT=$(curl -s "https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=https://lucasstahl.com/gems&strategy=desktop&category=performance&category=accessibility&category=best-practices&category=seo")

          PERF=$(echo $RESULT | jq -r '(.lighthouseResult.categories.performance.score // 0) * 100')
          A11Y=$(echo $RESULT | jq -r '(.lighthouseResult.categories.accessibility.score // 0) * 100')
          BP=$(echo $RESULT | jq -r '(.lighthouseResult.categories["best-practices"].score // 0) * 100')
          SEO=$(echo $RESULT | jq -r '(.lighthouseResult.categories.seo.score // 0) * 100')

          echo "performance=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$A11Y" >> $GITHUB_OUTPUT
          echo "best_practices=$BP" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

      - name: Generate Summary
        run: |
          echo "# üìä Weekly Performance Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Core Web Vitals" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Mobile (Homepage)" >> $GITHUB_STEP_SUMMARY
          echo "- **LCP**: ${{ steps.home.outputs.lcp }}ms (target: <2500ms)" >> $GITHUB_STEP_SUMMARY
          echo "- **CLS**: ${{ steps.home.outputs.cls }} (target: <0.1)" >> $GITHUB_STEP_SUMMARY
          echo "- **TBT**: ${{ steps.home.outputs.tbt }}ms (target: <300ms)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üñ•Ô∏è Desktop (Homepage)" >> $GITHUB_STEP_SUMMARY
          echo "- **LCP**: ${{ steps.home-desktop.outputs.lcp }}ms (target: <2500ms)" >> $GITHUB_STEP_SUMMARY
          echo "- **CLS**: ${{ steps.home-desktop.outputs.cls }} (target: <0.1)" >> $GITHUB_STEP_SUMMARY
          echo "- **TBT**: ${{ steps.home-desktop.outputs.tbt }}ms (target: <300ms)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì± Mobile Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Page | Performance | Accessibility | Best Practices | SEO |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|---------------|----------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Home | ${{ steps.home.outputs.performance }} | ${{ steps.home.outputs.accessibility }} | ${{ steps.home.outputs.best_practices }} | ${{ steps.home.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| About | ${{ steps.about.outputs.performance }} | ${{ steps.about.outputs.accessibility }} | ${{ steps.about.outputs.best_practices }} | ${{ steps.about.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog | ${{ steps.blog.outputs.performance }} | ${{ steps.blog.outputs.accessibility }} | ${{ steps.blog.outputs.best_practices }} | ${{ steps.blog.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Builds | ${{ steps.builds.outputs.performance }} | ${{ steps.builds.outputs.accessibility }} | ${{ steps.builds.outputs.best_practices }} | ${{ steps.builds.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gems | ${{ steps.gems.outputs.performance }} | ${{ steps.gems.outputs.accessibility }} | ${{ steps.gems.outputs.best_practices }} | ${{ steps.gems.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üñ•Ô∏è Desktop Lighthouse Scores" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Page | Performance | Accessibility | Best Practices | SEO |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|---------------|----------------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Home | ${{ steps.home-desktop.outputs.performance }} | ${{ steps.home-desktop.outputs.accessibility }} | ${{ steps.home-desktop.outputs.best_practices }} | ${{ steps.home-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| About | ${{ steps.about-desktop.outputs.performance }} | ${{ steps.about-desktop.outputs.accessibility }} | ${{ steps.about-desktop.outputs.best_practices }} | ${{ steps.about-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Blog | ${{ steps.blog-desktop.outputs.performance }} | ${{ steps.blog-desktop.outputs.accessibility }} | ${{ steps.blog-desktop.outputs.best_practices }} | ${{ steps.blog-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Builds | ${{ steps.builds-desktop.outputs.performance }} | ${{ steps.builds-desktop.outputs.accessibility }} | ${{ steps.builds-desktop.outputs.best_practices }} | ${{ steps.builds-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gems | ${{ steps.gems-desktop.outputs.performance }} | ${{ steps.gems-desktop.outputs.accessibility }} | ${{ steps.gems-desktop.outputs.best_practices }} | ${{ steps.gems-desktop.outputs.seo }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View detailed reports on PageSpeed Insights](https://pagespeed.web.dev/?url=https://lucasstahl.com/)" >> $GITHUB_STEP_SUMMARY

      - name: Check Thresholds
        run: |
          FAIL=0

          echo "### üì± Mobile Performance Checks"
          # Check mobile pages against thresholds
          if (( $(echo "${{ steps.home.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Home (mobile) performance score (${{ steps.home.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.about.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå About (mobile) performance score (${{ steps.about.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.blog.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Blog (mobile) performance score (${{ steps.blog.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.builds.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Builds (mobile) performance score (${{ steps.builds.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.gems.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Gems (mobile) performance score (${{ steps.gems.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          echo ""
          echo "### üñ•Ô∏è Desktop Performance Checks"
          # Check desktop pages against thresholds
          if (( $(echo "${{ steps.home-desktop.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Home (desktop) performance score (${{ steps.home-desktop.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.about-desktop.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå About (desktop) performance score (${{ steps.about-desktop.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.blog-desktop.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Blog (desktop) performance score (${{ steps.blog-desktop.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.builds-desktop.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Builds (desktop) performance score (${{ steps.builds-desktop.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.gems-desktop.outputs.performance }} < 85" | bc -l) )); then
            echo "‚ùå Gems (desktop) performance score (${{ steps.gems-desktop.outputs.performance }}) below threshold (85)"
            FAIL=1
          fi

          echo ""
          echo "### üéØ Core Web Vitals Checks"
          # Check Mobile Core Web Vitals
          if (( $(echo "${{ steps.home.outputs.lcp }} > 2500" | bc -l) )); then
            echo "‚ùå Mobile LCP (${{ steps.home.outputs.lcp }}ms) exceeds target (2500ms)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.home.outputs.cls }} > 0.1" | bc -l) )); then
            echo "‚ùå Mobile CLS (${{ steps.home.outputs.cls }}) exceeds target (0.1)"
            FAIL=1
          fi

          # Check Desktop Core Web Vitals
          if (( $(echo "${{ steps.home-desktop.outputs.lcp }} > 2500" | bc -l) )); then
            echo "‚ùå Desktop LCP (${{ steps.home-desktop.outputs.lcp }}ms) exceeds target (2500ms)"
            FAIL=1
          fi

          if (( $(echo "${{ steps.home-desktop.outputs.cls }} > 0.1" | bc -l) )); then
            echo "‚ùå Desktop CLS (${{ steps.home-desktop.outputs.cls }}) exceeds target (0.1)"
            FAIL=1
          fi

          echo ""
          if [ $FAIL -eq 1 ]; then
            echo "‚ö†Ô∏è Performance check failed - scores below thresholds"
            exit 1
          else
            echo "‚úÖ All performance checks passed!"
          fi
