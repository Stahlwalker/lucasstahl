---
interface Props {
	message: string;
	link?: string;
	announcementId: string; // Unique ID to track dismissal in localStorage
}

const { message, link, announcementId } = Astro.props;

// Check if message starts with "New:" and split it for styling
const startsWithNew = message.startsWith('New:');
const messageContent = startsWithNew
	? { prefix: 'New:', rest: message.slice(4).trim() }
	: { prefix: '', rest: message };
---

<div class="announcement-bar" data-announcement-id={announcementId}>
	{link ? (
		<a href={link} class="announcement-link" target="_blank" rel="noopener noreferrer">
			<span class="announcement-message">
				{startsWithNew && <span class="announcement-highlight">{messageContent.prefix}</span>}
				{' '}{messageContent.rest}
			</span>
			<i class="fa-solid fa-arrow-right announcement-arrow"></i>
		</a>
	) : (
		<div class="announcement-content">
			<span class="announcement-message">
				{startsWithNew && <span class="announcement-highlight">{messageContent.prefix}</span>}
				{' '}{messageContent.rest}
			</span>
		</div>
	)}
	<button class="announcement-close" aria-label="Dismiss announcement">
		<i class="fa-solid fa-xmark"></i>
	</button>
</div>

<style>
	.announcement-bar {
		background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
		border-bottom: 1px solid rgba(96, 165, 250, 0.5);
		padding: 0.375rem 1rem;
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1rem;
		position: relative;
		overflow: hidden;
		animation: slideDown 0.3s ease-out;
	}

	@keyframes slideDown {
		from {
			transform: translateY(-100%);
			opacity: 0;
		}
		to {
			transform: translateY(0);
			opacity: 1;
		}
	}

	.announcement-bar.hiding {
		animation: slideUp 0.3s ease-out forwards;
	}

	@keyframes slideUp {
		from {
			transform: translateY(0);
			opacity: 1;
		}
		to {
			transform: translateY(-100%);
			opacity: 0;
		}
	}

	.announcement-link {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.5rem;
		flex: 1;
		color: #ffffff;
		text-decoration: none;
		transition: all 0.2s ease;
		padding: 0.65rem 0.75rem;
		margin: -0.4rem -0.75rem;
	}

	.announcement-link:hover {
		color: #93c5fd;
	}

	.announcement-link:hover .announcement-arrow {
		transform: translateX(3px);
	}

	.announcement-content {
		display: flex;
		align-items: center;
		gap: 0;
		flex: 1;
		justify-content: center;
		flex-wrap: wrap;
	}

	.announcement-message {
		color: inherit;
		font-size: 0.875rem;
		font-weight: 500;
		font-family: 'Inter', sans-serif;
		text-align: center;
	}

	.announcement-highlight {
		color: #c3e88d;
		font-weight: 600;
		display: inline-block;
		animation: gentlePulse 2s ease-in-out infinite;
	}

	@keyframes gentlePulse {
		0%, 100% {
			transform: scale(1);
			text-shadow: 0 0 10px rgba(195, 232, 141, 0.5);
		}
		50% {
			transform: scale(1.05);
			text-shadow: 0 0 20px rgba(195, 232, 141, 0.9), 0 0 30px rgba(195, 232, 141, 0.5);
		}
	}

	.announcement-arrow {
		font-size: 0.875rem;
		flex-shrink: 0;
		color: #c3e88d;
		position: relative;
		animation: arrowGlow 3s ease-in-out infinite;
	}

	@keyframes arrowGlow {
		0%, 100% {
			text-shadow: 0 0 10px rgba(195, 232, 141, 0.5), 0 0 20px rgba(195, 232, 141, 0.3);
		}
		50% {
			text-shadow: 0 0 20px rgba(195, 232, 141, 0.9), 0 0 30px rgba(195, 232, 141, 0.5), 0 0 40px rgba(195, 232, 141, 0.3);
		}
	}

	.announcement-close {
		background: none;
		border: none;
		color: #ffffff;
		cursor: pointer;
		padding: 0.25rem 0.5rem;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 4px;
		transition: all 0.2s ease;
		opacity: 0.9;
		flex-shrink: 0;
	}

	.announcement-close:hover {
		opacity: 1;
		background: rgba(255, 255, 255, 0.1);
	}

	.announcement-close i {
		font-size: 1rem;
	}

	/* Touch device improvements */
	@media (hover: none) and (pointer: coarse) {
		.announcement-close {
			padding: 0.5rem;
		}
	}

	/* Light mode styles */
	:global([data-theme="light"]) .announcement-bar {
		background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
		border-bottom: 1px solid #93c5fd;
	}

	:global([data-theme="light"]) .announcement-link {
		color: #1e293b;
	}

	:global([data-theme="light"]) .announcement-link:hover {
		color: #2563eb;
	}

	:global([data-theme="light"]) .announcement-message {
		color: inherit;
	}

	:global([data-theme="light"]) .announcement-highlight {
		color: #7c3aed;
		font-weight: 600;
	}

	@keyframes gentlePulseLight {
		0%, 100% {
			transform: scale(1);
			text-shadow: 0 0 10px rgba(124, 58, 237, 0.3);
		}
		50% {
			transform: scale(1.05);
			text-shadow: 0 0 20px rgba(124, 58, 237, 0.6), 0 0 30px rgba(124, 58, 237, 0.3);
		}
	}

	:global([data-theme="light"]) .announcement-highlight {
		animation: gentlePulseLight 2s ease-in-out infinite;
	}

	:global([data-theme="light"]) .announcement-arrow {
		color: #7c3aed;
		animation: arrowGlowLight 3s ease-in-out infinite;
	}

	@keyframes arrowGlowLight {
		0%, 100% {
			text-shadow: 0 0 10px rgba(124, 58, 237, 0.3), 0 0 20px rgba(124, 58, 237, 0.15);
		}
		50% {
			text-shadow: 0 0 20px rgba(124, 58, 237, 0.6), 0 0 30px rgba(124, 58, 237, 0.3), 0 0 40px rgba(124, 58, 237, 0.15);
		}
	}

	:global([data-theme="light"]) .announcement-close {
		color: #1e293b;
		opacity: 0.7;
	}

	:global([data-theme="light"]) .announcement-close:hover {
		opacity: 1;
		background: rgba(0, 0, 0, 0.08);
	}

	/* Mobile responsive */
	@media (max-width: 768px) {
		.announcement-bar {
			padding: 0.25rem 0.5rem;
			gap: 0.5rem;
		}

		.announcement-link {
			gap: 0.4rem;
			padding: 0.375rem 0;
			margin: 0;
		}

		.announcement-content {
			padding: 0.375rem 0;
		}

		.announcement-message {
			font-size: 0.75rem;
			line-height: 1.4;
		}

		.announcement-arrow {
			font-size: 0.75rem;
		}

		.announcement-close {
			padding: 0.375rem 0.5rem;
		}

		.announcement-close i {
			font-size: 0.875rem;
		}
	}
</style>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const announcementBar = document.querySelector('.announcement-bar');
		if (!announcementBar) return;

		const announcementId = announcementBar.getAttribute('data-announcement-id');
		const closeButton = announcementBar.querySelector('.announcement-close');

		// Check if this announcement was previously dismissed
		const dismissedAnnouncements = JSON.parse(localStorage.getItem('dismissedAnnouncements') || '[]');

		if (dismissedAnnouncements.includes(announcementId)) {
			announcementBar.style.display = 'none';
			return;
		}

		// Handle close button click
		closeButton?.addEventListener('click', () => {
			announcementBar.classList.add('hiding');

			// Wait for animation to complete before hiding
			setTimeout(() => {
				announcementBar.style.display = 'none';

				// Save dismissal to localStorage
				const dismissed = JSON.parse(localStorage.getItem('dismissedAnnouncements') || '[]');
				if (!dismissed.includes(announcementId)) {
					dismissed.push(announcementId);
					localStorage.setItem('dismissedAnnouncements', JSON.stringify(dismissed));
				}
			}, 300);
		});
	});
</script>
